---
phase: 01-secure-server
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - server/index.ts
autonomous: false

must_haves:
  truths:
    - "Server starts with npm start and prints HTTPS and WSS URLs to console"
    - "Visiting https://localhost:8443 in Safari shows the placeholder page without any certificate warning"
    - "A WebSocket client can connect to wss://localhost:8443 and the server logs the connection"
  artifacts:
    - path: "server/index.ts"
      provides: "HTTPS static file server + WSS endpoint in single process"
      min_lines: 60
      exports: []
  key_links:
    - from: "server/index.ts"
      to: "certs/localhost.pem"
      via: "readFileSync at startup"
      pattern: "readFileSync.*certs/localhost\\.pem"
    - from: "server/index.ts"
      to: "certs/localhost-key.pem"
      via: "readFileSync at startup"
      pattern: "readFileSync.*certs/localhost-key\\.pem"
    - from: "server/index.ts"
      to: "addin/"
      via: "static file serving root directory"
      pattern: "resolve.*addin"
    - from: "WebSocketServer"
      to: "HTTPS server"
      via: "{ server } constructor option"
      pattern: "new WebSocketServer.*server"
    - from: "package.json"
      to: "server/index.ts"
      via: "npm start script"
      pattern: "node server/index\\.ts"
---

<objective>
Create the Node.js server that serves static files over HTTPS and accepts WebSocket connections over WSS, both on the same port using a single process.

Purpose: This is the core infrastructure of the bridge. The HTTPS server will serve the Office.js add-in files to PowerPoint. The WSS server will be the communication channel between the add-in and the bridge. Both must use TLS because macOS WKWebView (which PowerPoint uses) refuses plain ws:// connections.
Output: A working server/index.ts that can be started with `npm start`, verified with curl and a WebSocket test client, and visually confirmed in Safari.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-secure-server/01-RESEARCH.md
@.planning/phases/01-secure-server/01-01-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HTTPS + WSS server</name>
  <files>server/index.ts</files>
  <action>
Create `server/index.ts` — a single-file Node.js server that does three things: serves static files over HTTPS, accepts WebSocket connections over WSS, and provides clear startup/connection logging.

**Imports (use node: prefix for all builtins):**
- `node:https` — createServer
- `node:fs` — readFileSync, existsSync
- `node:path` — join, extname, resolve
- `ws` — WebSocketServer (import `{ WebSocketServer }` from 'ws')
- Import types with `import type` per verbatimModuleSyntax

**Constants:**
- `PORT = 8443` (standard alternative HTTPS port)
- `CERT_PATH = './certs/localhost.pem'`
- `KEY_PATH = './certs/localhost-key.pem'`
- `STATIC_DIR = resolve('./addin')` (resolve to absolute path for security check)

**Startup cert check:**
Before creating the server, check that both cert files exist. If either is missing, print a clear error message telling the user to run `npm run setup-certs` and exit with code 1. Do NOT proceed with a broken server.

**MIME type map (as const object, NOT an enum):**
```
'.html' -> 'text/html; charset=UTF-8'
'.js'   -> 'text/javascript'
'.css'  -> 'text/css'
'.json' -> 'application/json'
'.png'  -> 'image/png'
'.ico'  -> 'image/x-icon'
```
Default: 'application/octet-stream'

**Static file serving function (serveStatic):**
- Extract URL path from request (default '/' to '/index.html')
- Resolve the full file path using `resolve(join(STATIC_DIR, urlPath))`
- SECURITY: Check that resolved path starts with STATIC_DIR — if not, return 403 Forbidden (prevents path traversal attacks like `GET /../../etc/passwd`)
- If file doesn't exist, return 404 Not Found
- Read file, determine MIME type from extension, return 200 with content

**HTTPS server:**
- Create with `createServer({ cert, key }, serveStatic)`
- Read cert and key with `readFileSync`

**WebSocket server:**
- Create `new WebSocketServer({ server })` — attaches to the HTTPS server, sharing port 8443
- On 'connection': log "WebSocket client connected"
- On 'message': log the received message (toString())
- On 'close': log "WebSocket client disconnected"
- On 'error': log the error

**Server startup:**
- `server.listen(PORT, callback)`
- In callback, log:
  - `Bridge server running`
  - `  HTTPS: https://localhost:${PORT}`
  - `  WSS:   wss://localhost:${PORT}`

**Things to AVOID:**
- Do NOT use `enum` (Node 24 type stripping does not support enums — use `as const` objects)
- Do NOT omit `.ts` extension in any import from local files (Node native TS requires explicit extensions). This file has no local imports yet, so this is just a note for future.
- Do NOT use `require()` — use ESM `import` syntax (package.json is type:module)
- Do NOT use Express — native node:https is sufficient for serving a handful of static files
- Do NOT use `readFile` (async) for cert loading — `readFileSync` at startup is fine and simpler
  </action>
  <verify>
1. `npx tsc --noEmit` — no TypeScript errors
2. Start server in background: `node server/index.ts &` (capture PID)
3. `curl -s https://localhost:8443` — returns HTML containing "PowerPoint Bridge" (if mkcert CA is trusted, no -k flag needed; if curl complains about cert, use `curl -sk https://localhost:8443`)
4. `curl -s -o /dev/null -w "%{http_code}" https://localhost:8443/nonexistent` — returns 404
5. WebSocket test: `node -e "const ws = new WebSocket('wss://localhost:8443'); ws.onopen = () => { console.log('Connected!'); ws.close(); process.exit(0); }; ws.onerror = (e) => { console.error('Failed:', e.message); process.exit(1); }; setTimeout(() => { console.error('Timeout'); process.exit(1); }, 5000);"` — If native WS client rejects the cert, use: `NODE_TLS_REJECT_UNAUTHORIZED=0` prefix
6. Kill the background server process
  </verify>
  <done>server/index.ts exists, passes type checking, starts without errors, serves addin/index.html over HTTPS, and accepts WSS connections. Server logs clearly show HTTPS and WSS URLs on startup and connection events.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify HTTPS and WSS in Safari</name>
  <what-built>
A complete secure server infrastructure:
- TLS certificates trusted by macOS Keychain (from Plan 01)
- HTTPS server serving the placeholder page at https://localhost:8443
- WSS server accepting WebSocket connections at wss://localhost:8443
- All in a single Node.js process started with `npm start`
  </what-built>
  <how-to-verify>
The server should already be running from Task 1 verification. If not, start it: `npm start`

1. Open Safari and visit https://localhost:8443
   - EXPECTED: The page loads showing "PowerPoint Bridge" heading
   - EXPECTED: No certificate warning, no red lock icon, no "This Connection Is Not Private" page
   - If you see a cert warning: mkcert CA may not be trusted. Run `mkcert -install` and enter your password when prompted, then reload Safari.

2. Open Safari Developer Tools (Develop menu > Show Web Inspector > Console tab)
   - Type: `new WebSocket('wss://localhost:8443')` and press Enter
   - EXPECTED: The server terminal shows "WebSocket client connected"
   - This confirms WSS works from a browser context (same environment the Office.js add-in will use)

3. Check the terminal where the server is running
   - EXPECTED: You see startup log lines for HTTPS and WSS URLs
   - EXPECTED: You see "WebSocket client connected" from step 2
  </how-to-verify>
  <resume-signal>Type "approved" if the page loads without cert warnings and WSS connects. Describe any issues if something fails.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria from ROADMAP.md:
1. Running mkcert generates certificate files and they are trusted by macOS Keychain (no manual trust steps beyond mkcert -install) -- verified by Plan 01
2. Visiting https://localhost:8443 in Safari shows the add-in page without any certificate warning -- verified by Task 2 checkpoint
3. A test WebSocket client can connect to wss://localhost:8443 and receive a response -- verified by Task 1 automated test and Task 2 Safari test
</verification>

<success_criteria>
- `npm start` launches the server and prints HTTPS + WSS URLs
- `curl https://localhost:8443` returns the placeholder HTML page
- Safari shows the page at https://localhost:8443 with no certificate warnings
- A WebSocket client connects to wss://localhost:8443 and the server logs the connection
- `npx tsc --noEmit` reports no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-secure-server/01-02-SUMMARY.md`
</output>
