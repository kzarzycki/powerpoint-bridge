---
phase: 02-powerpoint-addin
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - addin/app.js
autonomous: false

must_haves:
  truths:
    - "Taskpane displays Connected with green indicator when bridge server is running"
    - "Taskpane displays Disconnected with red indicator when bridge server is stopped"
    - "Add-in automatically reconnects with exponential backoff when server restarts"
    - "Add-in appears in PowerPoint ribbon after sideloading manifest"
  artifacts:
    - path: "addin/app.js"
      provides: "Office.js initialization, WebSocket client, reconnection, status display"
      min_lines: 40
  key_links:
    - from: "addin/app.js"
      to: "Office.onReady"
      via: "initialization callback"
      pattern: "Office\\.onReady"
    - from: "addin/app.js"
      to: "wss://localhost:8443"
      via: "WebSocket constructor"
      pattern: "new WebSocket.*wss://localhost:8443"
    - from: "addin/app.js"
      to: "#status element"
      via: "DOM update on open/close"
      pattern: "getElementById.*status"
---

<objective>
Create the WebSocket client JavaScript that connects the add-in to the bridge server, then verify the complete add-in works inside PowerPoint.

Purpose: This is the dynamic behavior layer. app.js handles Office.js initialization, establishes the WSS connection to the bridge server, displays connection status in the taskpane, and automatically reconnects with exponential backoff when the connection drops. After creating app.js, we sideload the manifest and verify the full add-in works live in PowerPoint.

Output: Working add-in that shows Connected/Disconnected status in PowerPoint's taskpane.
</objective>

<execution_context>
@/Users/zarz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zarz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-powerpoint-addin/02-RESEARCH.md
@.planning/phases/02-powerpoint-addin/02-01-SUMMARY.md
@addin/index.html
@addin/style.css
@server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebSocket client with Office.js initialization and reconnection</name>
  <files>addin/app.js</files>
  <action>
    Create `addin/app.js` with the following components. Use plain JavaScript (no TypeScript, no modules — this runs in WKWebView as a classic script).

    1. **Office.onReady initialization:**
       ```javascript
       Office.onReady(function(info) {
         if (info.host === Office.HostType.PowerPoint) {
           console.log('Office.js ready:', info.host, info.platform);
           updateStatus('connecting');
           initWebSocket();
         }
       });
       ```
       Do NOT use Office.initialize (legacy). Do NOT use arrow functions or other ES6+ syntax that might be problematic — stick with `function` declarations to be safe in WKWebView.

       Also add a fallback for when the page loads outside PowerPoint (e.g., in a browser for testing): if Office.onReady hasn't fired within 3 seconds, call initWebSocket() anyway. This allows testing the WebSocket connection in a browser without PowerPoint.

    2. **WebSocket client with exponential backoff reconnection:**
       - URL: `wss://localhost:8443`
       - Variables: `ws` (current socket), `reconnectAttempt` (counter), `BASE_DELAY = 500`, `MAX_DELAY = 30000`
       - `connect()` function creates new WebSocket, sets handlers:
         - `onopen`: reset reconnectAttempt to 0, call `updateStatus('connected')`, log to console
         - `onclose`: call `updateStatus('disconnected')`, call `scheduleReconnect()`
         - `onerror`: log error, do nothing else (onclose fires after onerror)
         - `onmessage`: parse JSON, call `handleCommand(message)` (stub for Phase 3)
       - `scheduleReconnect()`: compute delay as `min(BASE_DELAY * 2^reconnectAttempt, MAX_DELAY)` plus random jitter (0-1000ms), increment reconnectAttempt, setTimeout to call connect()

    3. **Status display update:**
       `updateStatus(state)` function that:
       - Gets `#status` element
       - Sets text content: "Connected" / "Disconnected" / "Connecting..."
       - Removes all state classes (connected, disconnected, connecting), adds the current state class
       - This works with the CSS classes from style.css (Plan 02-01)

    4. **Command handler stub:**
       `handleCommand(message)` function that logs the received message to console. This is the hook point for Phase 3's command execution engine. For now, just:
       ```javascript
       function handleCommand(message) {
         console.log('Received command:', message);
       }
       ```

    5. **initWebSocket wrapper:**
       Simple function that calls `connect()`. Exists as a named entry point called from Office.onReady.

    Keep the file focused and small — under 80 lines. No framework, no imports, no build step.
  </action>
  <verify>
    Start the bridge server and load the page in a browser to verify WebSocket connects:
    ```bash
    # Start server in background
    node server/index.ts &
    SERVER_PID=$!
    sleep 1

    # Verify app.js is served
    curl -sk https://localhost:8443/app.js | grep -q "Office.onReady" && echo "OK: Office.onReady" || echo "FAIL"
    curl -sk https://localhost:8443/app.js | grep -q "WebSocket" && echo "OK: WebSocket" || echo "FAIL"
    curl -sk https://localhost:8443/app.js | grep -q "scheduleReconnect" && echo "OK: reconnection" || echo "FAIL"

    kill $SERVER_PID
    ```

    Also verify the file is syntactically valid JavaScript:
    ```bash
    node --check addin/app.js && echo "OK: valid JS" || echo "FAIL: syntax error"
    ```
  </verify>
  <done>
    addin/app.js exists with Office.onReady initialization, WebSocket client connecting to wss://localhost:8443, exponential backoff reconnection, status display updates, and command handler stub. File passes syntax check.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Office.js add-in: manifest XML, taskpane HTML with Office.js CDN, CSS status styling, icon assets, and WebSocket client with auto-reconnection. All served from the HTTPS bridge server on port 8443.
  </what-built>
  <how-to-verify>
    **Setup (Claude will run the sideload command first):**
    Run `npm run sideload` to copy manifest to PowerPoint's wef directory.

    **Then you (the user) verify:**

    1. **Quit PowerPoint completely** (Cmd+Q, not just close window)
    2. **Start the bridge server:** `npm start` (in a terminal)
    3. **Open PowerPoint** and create or open any presentation
    4. **Find the add-in:** Look in the Home tab ribbon for "PowerPoint Bridge" button (may be under a "Bridge" group label, or under Insert > My Add-ins if not in ribbon)
    5. **Click the add-in button** — a taskpane should open on the right side
    6. **Verify "Connected"** — the taskpane should show "Connected" with a green indicator
    7. **Test disconnect:** Stop the bridge server (Ctrl+C in terminal). The taskpane should show "Disconnected" with a red indicator within a few seconds.
    8. **Test reconnect:** Start the server again (`npm start`). The taskpane should automatically reconnect and show "Connected" again (may take up to 30 seconds due to backoff).

    **Expected result:** Steps 6-8 all work. The add-in loads, connects, shows disconnect on server stop, and auto-reconnects on server restart.

    **If the add-in doesn't appear in the ribbon:**
    - Check that `~/Library/Containers/com.microsoft.Powerpoint/Data/Documents/wef/manifest.xml` exists
    - Make sure you fully quit and reopened PowerPoint (not just closed the window)
    - Try Insert > My Add-ins > Shared Folder tab
  </how-to-verify>
  <resume-signal>Type "approved" if Connected/Disconnected states work correctly, or describe what went wrong.</resume-signal>
</task>

</tasks>

<verification>
1. addin/app.js contains Office.onReady, WebSocket client, exponential backoff, status updates
2. WebSocket connects to wss://localhost:8443 (same port as HTTPS server)
3. Status element updates: "Connected" (green) when server running, "Disconnected" (red) when stopped
4. Auto-reconnection works with exponential backoff (no rapid-fire reconnects)
5. Add-in appears in PowerPoint ribbon after sideloading manifest
6. Taskpane opens and shows live connection status
</verification>

<success_criteria>
- User confirms add-in loads in PowerPoint taskpane
- User confirms "Connected" status when server is running
- User confirms "Disconnected" status when server is stopped
- User confirms auto-reconnection when server restarts
</success_criteria>

<output>
After completion, create `.planning/phases/02-powerpoint-addin/02-02-SUMMARY.md`
</output>
